<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- Load Bootstrap and jQuery framework. -->
    <link
      href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.3/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script
      src="https://kit.fontawesome.com/71e3554019.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.3/js/bootstrap.min.js"
      crossorigin="anonymous"
    ></script>
    <!-- Load custom styles and scripts. -->
    <style>
      .container {
        margin-top: 10px;
        margin-bottom: 10px;
      }
      .jumbotron {
        background-color: white;
        padding-top: 10px;
        padding-bottom: 0px;
        margin-bottom: 0px;
      }
      .form-control,
      .list-group-item {
        white-space: pre-wrap;
        font-size: 18px;
        font-family: 'Courier New', Courier, monospace;
        font-weight: 400;
        resize: none;
      }
      .btn:focus,
      .form-control:focus {
        box-shadow: none;
      }
      .list-group {
        display: block;
        padding: 25px;
        padding-top: 15px;
      }
    </style>
    <script>
      // Refresh the list of notes.
      function refresh(notes) {
        $('#note-list').empty();
        for (var i = 0; i < notes.length; i++) {
          notes[i].Time = changeDateFormat(notes[i].Time);
          var addtion =
            '<li class="list-group-item"><div class="media"><div class="media-body"><h6><i class="far fa-calendar-alt"></i> ' +
            notes[i].Time +
            '</h6><span>' +
            notes[i].Content +
            '</span></div></div></li>';
          // FIXME: Optimize the refresh effect of the list.
          $(addtion).prependTo('#note-list');
        }
      }
      // Request to the server and refresh all notes.
      function loadAllNotes() {
        $.ajax({
          url: '/data',
          type: 'get',
          data: null,
          dataType: 'json',
          success: function (data) {
            $('#submit').removeClass('btn-danger').addClass('btn-success');
            refresh(data.notes);
          },
          error: function () {
            $('#submit').removeClass('btn-success').addClass('btn-danger');
          },
        });
      }
      // Parse the date format in mongodb into a simple date format.
      function changeDateFormat(cellval) {
        var dateVal = cellval + '';
        if (cellval != null) {
          // Use regular expressions.
          var reg = new RegExp('.\\d{3}\\+\\d{4}$');
          var date = new Date(dateVal.replace(reg, '').replace('T', ' '));
          var month =
            date.getMonth() + 1 < 10
              ? '0' + (date.getMonth() + 1)
              : date.getMonth() + 1;
          var day = date.getDate() < 10 ? '0' + date.getDate() : date.getDate();
          return date.getFullYear() + '-' + month + '-' + day;
        }
      }
      // Load all notes when the interface is loaded.
      $(document).ready(loadAllNotes());
      $(document).ready(function () {
        // Textarea adaptive height is supported.
        $('textarea')
          .each(function () {
            this.setAttribute(
              'style',
              'height:' + this.scrollHeight + 'px;overflow-y:hidden;'
            );
          })
          .on('input', function () {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
          });
        // Support the tab key's use in textarea.
        $('textarea').on('keydown', function (e) {
          if (e.keyCode == 9) {
            e.preventDefault();
            var indent = '    ';
            var start = this.selectionStart;
            var end = this.selectionEnd;
            var selected = window.getSelection().toString();
            selected = indent + selected.replace(/\n/g, '\n' + indent);
            this.value =
              this.value.substring(0, start) +
              selected +
              this.value.substring(end);
            this.setSelectionRange(
              start + indent.length,
              start + selected.length
            );
          }
        });
        // Function to add log items to the log list.
        $('#submit').click(function () {
          var formParam = $('#form-write').serialize();
          $('textarea').val('');
          $('textarea').height(24);
          $.ajax({
            url: '/data',
            type: 'post',
            data: formParam,
            dataType: 'json',
            success: function () {
              $('#submit').removeClass('btn-danger').addClass('btn-success');
              // Get and refresh the log list after each submission.
              loadAllNotes();
            },
            error: function () {
              $('#submit').removeClass('btn-success').addClass('btn-danger');
            },
          });
        });
      });
    </script>
    <title>Labnote</title>
  </head>
  <body>
    <div class="container">
      <div class="jumbotron">
        <h1 class="display-3">Hello, world!</h1>
        <p class="lead">
          This is a laboratory log, used to record the good times and trivial
          things here.
        </p>
        <hr class="my-2" />
        <p>Please write down what you want to record here.</p>
        <form id="form-write" class="form-input">
          <div class="input-group">
            <textarea class="form-control" name="content" rows="1"></textarea>
            <div class="input-group-append">
              <button id="submit" class="btn btn-success" type="button">
                <i class="fas fa-pencil-alt"></i>
              </button>
            </div>
          </div>
        </form>
      </div>
      <ul id="note-list" class="list-group list-group-flush">
        <!-- There is going to add some notes. -->
      </ul>
    </div>
  </body>
</html>
